# coding: utf-8
import gradio as gr
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime
import tempfile
import os
import math
import numpy as np
import traceback
from typing import List, Tuple, Dict, Optional, Any
import html

from fx_utils import get_fx_rate, CURRENCY_UNIT
from investment_calc import get_period_params, calculate_fv, rule_of_72

FONT_STACK = "'Noto Sans TC', 'Inter', 'æ€æºé»‘é«”', -apple-system, BlinkMacSystemFont, sans-serif"
DEFAULT_SENSITIVITY_PERCENTAGES = [-2.0, -1.0, 1.0, 2.0]

def format_base_card(card_type, title, message, details=None):
    type_map = {
        "success": {"icon": "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z", "color": "green", "bg_grad": "from-green-100 to-emerald-100", "border": "border-green-300", "text": "text-green-800", "icon_bg": "bg-green-500"},
        "warning": {"icon": "M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z", "color": "yellow", "bg_grad": "from-yellow-100 to-amber-100", "border": "border-yellow-300", "text": "text-yellow-800", "icon_bg": "bg-yellow-500"},
        "error": {"icon": "M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z", "color": "red", "bg_grad": "from-red-100 to-rose-100", "border": "border-red-300", "text": "text-red-800", "icon_bg": "bg-red-500"},
        "info": {"icon": "M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z", "color": "blue", "bg_grad": "from-blue-100 to-indigo-100", "border": "border-blue-300", "text": "text-blue-800", "icon_bg": "bg-blue-500"},
    }
    config = type_map.get(card_type, type_map["info"])
    html_content = f"""<div class="result-card-override rounded-2xl p-6 bg-gradient-to-br {config['bg_grad']} border {config['border']} shadow-md mb-6" style="font-family: {FONT_STACK} !important;"><div class="flex items-start"><div class="w-12 h-12 {config['icon_bg']} rounded-xl flex items-center justify-center mr-4 flex-shrink-0"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="{config['icon']}" clip-rule="evenodd"/></svg></div><div><h3 class="text-xl font-bold {config['text']} mb-1" style="font-family: {FONT_STACK} !important;">{title}</h3><p class="{config['text']} opacity-90 leading-relaxed" style="font-family: {FONT_STACK} !important;">{message}</p>"""
    if details and isinstance(details, dict):
        html_content += "<div class='mt-4 space-y-2 border-t border-gray-300 pt-3'>"
        for key, value in details.items():
            safe_value = html.escape(str(value))
            safe_value_html = safe_value.replace("<strong>", "<strong>").replace("</strong>", "</strong>").replace("<span", "<span").replace("</span>", "</span>").replace("<br>", "<br>")
            html_content += f"""<div class='flex justify-between items-center text-sm' style="font-family: {FONT_STACK} !important;"><span class='font-medium {config['text']} opacity-80'>{html.escape(str(key))}:</span><span class='font-bold {config['text']}'>{safe_value_html}</span></div>"""
        html_content += "</div>"
    html_content += """</div></div></div>"""
    return html_content

def format_success_html(title, message, details=None): return format_base_card("success", title, message, details)
def format_warning_html(title, message, details=None): return format_base_card("warning", title, message, details)
def format_error_html(title, message="è«‹æª¢æŸ¥è¼¸å…¥æˆ–ç¨å¾Œå†è©¦ã€‚"):
    if message == "è«‹æª¢æŸ¥è¼¸å…¥æˆ–ç¨å¾Œå†è©¦ã€‚": message = title; title = "âŒ ç™¼ç”ŸéŒ¯èª¤"
    return format_base_card("error", title, message)
def format_info_html(title, message, details=None): return format_base_card("info", title, message, details)

def run_sensitivity_analysis(initial, periodic, years, base_rate_percent, invest_freq, invest_custom_months, compound_freq, reinvest, inflation_rate_annual, rate_deltas_percent=DEFAULT_SENSITIVITY_PERCENTAGES):
    results = {}
    all_deltas = sorted(list(set(rate_deltas_percent + [0.0])))
    print(f"é–‹å§‹åŸ·è¡Œæ•æ„Ÿåº¦åˆ†æï¼ŒåŸºæº–åˆ©ç‡: {base_rate_percent:.1f}%ï¼Œè®Šå‹•: {rate_deltas_percent}")
    for delta in all_deltas:
        current_rate_percent = base_rate_percent + delta
        current_rate_percent = max(0.01, current_rate_percent)
        delta_str = f" ({delta:+.1f}%)" if delta != 0 else " (åŸºæº–)"
        rate_key = f"{current_rate_percent:.1f}%{delta_str}"
        results[rate_key] = {'nominal_fv': None, 'real_fv': None}
        try:
            _, r_period_sens, inv_per_yr_sens, comp_per_yr_sens = get_period_params(years, current_rate_percent, invest_freq, invest_custom_months, compound_freq)
            final_nominal_sens, _, _, df_sens = calculate_fv(initial, periodic, years, r_period_sens, inv_per_yr_sens, comp_per_yr_sens, reinvest, inflation_rate_annual)
            final_real_sens = np.nan
            if df_sens is not None and not df_sens.empty:
                real_col_sens = "è¤‡åˆ©å¯¦è³ªçµ‚å€¼" if reinvest == "è¤‡åˆ©å†æŠ•å…¥" else "å–®åˆ©å¯¦è³ªçµ‚å€¼"
                if real_col_sens in df_sens.columns:
                    final_real_sens = df_sens.iloc[-1][real_col_sens]
            results[rate_key]['nominal_fv'] = final_nominal_sens
            results[rate_key]['real_fv'] = final_real_sens if not np.isnan(final_real_sens) else None
        except Exception as e:
            print(f"è­¦å‘Šï¼šæ•æ„Ÿåº¦åˆ†æåœ¨åˆ©ç‡ {rate_key} æ™‚è¨ˆç®—å¤±æ•—: {e}")
    print("æ•æ„Ÿåº¦åˆ†æå®Œæˆã€‚")
    return results

def assess_risk(years, rate):
    if years <= 1:
        level = "æ¥µé«˜"
        desc = "çŸ­æœŸæŠ•è³‡å—å¸‚å ´æ³¢å‹•å½±éŸ¿å·¨å¤§ï¼Œé æœŸé«˜å ±é…¬é€šå¸¸ä¼´éš¨æ¥µé«˜é¢¨éšªã€‚"
    elif years <= 5:
        if rate > 15: level, desc = "é«˜", "ä¸­çŸ­æœŸè¿½æ±‚é«˜å ±é…¬ï¼Œéœ€æ‰¿å—è¼ƒå¤§å¸‚å ´æ³¢å‹•é¢¨éšªã€‚"
        elif rate > 8: level, desc = "ä¸­é«˜", "ä¸­çŸ­æœŸæŠ•è³‡ï¼Œå ±é…¬ç‡é æœŸè¼ƒç©æ¥µï¼Œé¢¨éšªç›¸å°è¼ƒé«˜ã€‚"
        else: level, desc = "ä¸­ç­‰", "ä¸­çŸ­æœŸæŠ•è³‡ï¼Œé¢¨éšªèˆ‡å ±é…¬é æœŸç›¸å°å¹³è¡¡ã€‚"
    elif years <= 10:
        if rate > 12: level, desc = "ä¸­é«˜", "ä¸­é•·æœŸæŠ•è³‡ï¼Œè¿½æ±‚è¼ƒé«˜å ±é…¬æ„å‘³è‘—éœ€æ‰¿æ“”ç›¸æ‡‰é¢¨éšªã€‚"
        elif rate > 7: level, desc = "ä¸­ç­‰", "ä¸­é•·æœŸæŠ•è³‡ï¼Œé¢¨éšªèˆ‡å ±é…¬é æœŸè¼ƒç‚ºå¹³è¡¡ã€‚"
        else: level, desc = "ä¸­ä½", "ä¸­é•·æœŸæŠ•è³‡ï¼Œå ±é…¬é æœŸè¼ƒä¿å®ˆï¼Œé¢¨éšªç›¸å°è¼ƒä½ã€‚"
    else:
        if rate > 10: level, desc = "ä¸­ç­‰", "é•·æœŸæŠ•è³‡æœ‰åŠ©å¹³æ»‘æ³¢å‹•ï¼Œä½†éé«˜å ±é…¬é æœŸä»æœ‰é¢¨éšªã€‚"
        elif rate > 6: level, desc = "ä¸­ä½", "é•·æœŸæŠ•è³‡ï¼Œé¢¨éšªç›¸å°å¯æ§ï¼Œå ±é…¬é æœŸè¼ƒç©©å¥ã€‚"
        else: level, desc = "ä½", "é•·æœŸæŠ•è³‡ä¸”å ±é…¬é æœŸä¿å®ˆï¼Œé¢¨éšªæœ€ä½ã€‚"
    return level, desc

def format_result_html(html_override, final_nominal, total_invested, total_nominal_gain, final_fx, total_invested_fx, total_gain_fx, base_ccy, output_ccy, fx_rate, rate, mode, initial, periodic, years, invest_freq, compound_freq, reinvest, df_path, sensitivity_results, inflation_rate_annual, risk_level, risk_desc):
    if html_override: return html_override
    base_unit = CURRENCY_UNIT.get(base_ccy, base_ccy)
    output_unit = CURRENCY_UNIT.get(output_ccy, output_ccy)
    reinvest_zh = "è¤‡åˆ©å†æŠ•å…¥" if reinvest=="è¤‡åˆ©å†æŠ•å…¥" else "å–®åˆ©"
    final_real = np.nan
    final_real_fx = np.nan
    if df_path is not None and not df_path.empty:
        try:
            final_row = df_path.iloc[-1]
            real_col = "è¤‡åˆ©å¯¦è³ªçµ‚å€¼" if reinvest == "è¤‡åˆ©å†æŠ•å…¥" else "å–®åˆ©å¯¦è³ªçµ‚å€¼"
            if real_col in final_row and pd.notna(final_row[real_col]):
                final_real = final_row[real_col]
                final_real_fx = final_real * fx_rate
        except IndexError:
             print("è­¦å‘Šï¼šç„¡æ³•å¾ DataFrame æœ€å¾Œä¸€è¡Œç²å–å¯¦è³ªåƒ¹å€¼ã€‚")
    final_real_str = f"{int(round(final_real)):,} {base_unit}" if pd.notna(final_real) else "N/A"
    final_real_fx_str = f" (â‰ˆ {int(round(final_real_fx)):,} {output_unit})" if pd.notna(final_real_fx) and base_ccy != output_ccy else ""
    total_return_rate = ((total_nominal_gain / total_invested) * 100) if total_invested != 0 else 0
    multiplier = (final_nominal / total_invested) if total_invested != 0 else 1
    doubling_time = rule_of_72(rate)
    doubling_time_str = f"{doubling_time:.1f} å¹´" if doubling_time else "N/A (å ±é…¬ç‡éœ€>0)"
    
    details = {
        f"ğŸ“ˆ **æœ€çµ‚åç›®åƒ¹å€¼ ({years:.1f}å¹´å¾Œ)**": f"**{int(round(final_nominal)):,} {base_unit}**" + (f" (â‰ˆ {int(round(final_fx)):,} {output_unit})" if base_ccy != output_ccy else ""),
    }
    if inflation_rate_annual > 0 and pd.notna(final_real):
        details[f"ğŸ“‰ **æœ€çµ‚å¯¦è³ªåƒ¹å€¼ (ä»Šæ—¥è³¼è²·åŠ›)**"] = f"**{final_real_str}**{final_real_fx_str}"
        details["ğŸˆ å¹´åŒ–é€šè†¨ç‡"] = f"{inflation_rate_annual * 100:.1f}%"
    details.update({
        "ğŸ’° ç¸½æŠ•å…¥æœ¬é‡‘": f"{int(round(total_invested)):,} {base_unit}" + (f" (â‰ˆ {int(round(total_invested_fx)):,} {output_unit})" if base_ccy != output_ccy else ""),
        "ğŸ’¸ åç›®ç¸½æ”¶ç›Š": f"{int(round(total_nominal_gain)):,} {base_unit}" + (f" (â‰ˆ {int(round(total_gain_fx)):,} {output_unit})" if base_ccy != output_ccy else ""),
        "ğŸ“Š ç¸¾æ•ˆæ‘˜è¦ (åç›®)": f"ç¸½å›å ±ç‡ <strong class='text-green-600'>{total_return_rate:.1f}%</strong> | è³‡é‡‘æˆé•· <strong class='text-purple-600'>{multiplier:.2f} å€</strong> | é ä¼°ç¿»å€æ™‚é–“ <strong class='text-blue-600'>{doubling_time_str}</strong> (72æ³•å‰‡)",
        "âš™ï¸ æ¨¡æ“¬åƒæ•¸": f"{invest_freq}æŠ•å…¥ | {compound_freq}è¤‡åˆ© | {reinvest_zh}",
        f"âš ï¸ é¢¨éšªè©•ä¼° ({years:.1f}å¹´, {rate:.1f}%)": f"<strong>{risk_level}</strong> - {risk_desc}",
        "ğŸ’± åŒ¯ç‡åƒè€ƒ": f"1 {base_ccy} â‰ˆ {fx_rate:.4f} {output_ccy}"
    })
    
    sensitivity_html = ""
    if sensitivity_results and mode != 'ç›®æ¨™åæ¨':
        sensitivity_html += "<div class='mt-4 border-t border-gray-300 pt-3'>"
        sensitivity_html += f"<h4 class='text-sm font-bold text-indigo-800 mb-2'>ğŸ“ˆ å ±é…¬ç‡æ•æ„Ÿåº¦åˆ†æ (Â±{DEFAULT_SENSITIVITY_PERCENTAGES[-1]:.0f}%)</h4>"
        sensitivity_html += "<ul class='text-xs space-y-1'>"
        sorted_rates = sorted(sensitivity_results.keys(), key=lambda x: float(x.split('%')[0]))
        base_result = sensitivity_results.get(f"{rate:.1f}% (åŸºæº–)", {'nominal_fv': np.nan, 'real_fv': np.nan})
        base_nominal = base_result.get('nominal_fv') if base_result else np.nan
        for rate_key in sorted_rates:
            value_dict = sensitivity_results[rate_key]
            nom_val = value_dict.get('nominal_fv')
            real_val = value_dict.get('real_fv')
            nom_val_str = f"{int(round(nom_val)):,} {base_unit}" if pd.notna(nom_val) else "N/A"
            real_val_str = f" / å¯¦è³ª: {int(round(real_val)):,} {base_unit}" if pd.notna(real_val) and inflation_rate_annual > 0 else ""
            nom_change_pct_str = ""
            if pd.notna(nom_val) and pd.notna(base_nominal) and base_nominal != 0 and "åŸºæº–" not in rate_key:
                nom_change_pct = ((nom_val - base_nominal) / base_nominal) * 100
                nom_change_pct_str = f" (<span style='color: {'green' if nom_change_pct > 0 else 'red'};'>{nom_change_pct:+.1f}%</span>)"
            style = "font-weight: bold;" if "åŸºæº–" in rate_key else ""
            sensitivity_html += f"<li style='{style}'> â€¢ {html.escape(rate_key)}: åç›®: {nom_val_str}{nom_change_pct_str}{real_val_str}</li>"
        sensitivity_html += "</ul></div>"
    title = "ğŸ’° æŠ•è³‡æˆæœé ä¼°"
    message = f"åŸºæ–¼æ‚¨çš„è¼¸å…¥ï¼Œä»¥ä¸‹æ˜¯ {years:.1f} å¹´å¾Œçš„æŠ•è³‡æ¨¡æ“¬çµæœï¼š"
    return format_success_html(title, message, details) + sensitivity_html

def generate_plot(df_path, reinvest, output_ccy, inflation_rate_annual=0.0):
    try:
        if df_path is None or df_path.empty or not isinstance(df_path, pd.DataFrame): return None
        df_plot = df_path.copy()
        yaxis_title = f"é‡‘é¡ ({CURRENCY_UNIT.get(output_ccy, output_ccy)})"
        show_real_value = inflation_rate_annual > 0
        nominal_final_col, nominal_compare_col_orig, real_final_col = "", "", ""
        if reinvest == "è¤‡åˆ©å†æŠ•å…¥":
            nominal_final_col, nominal_compare_col_orig = "è¤‡åˆ©åç›®çµ‚å€¼", "å–®åˆ©åç›®çµ‚å€¼"
            real_final_col = "è¤‡åˆ©å¯¦è³ªçµ‚å€¼"
            compare_col_new = "å–®åˆ©åƒ¹å€¼(æ¯”è¼ƒç”¨)"
        else:
            nominal_final_col, nominal_compare_col_orig = "å–®åˆ©åç›®çµ‚å€¼", "è¤‡åˆ©åç›®çµ‚å€¼"
            real_final_col = "å–®åˆ©å¯¦è³ªçµ‚å€¼"
            compare_col_new = "è¤‡åˆ©åƒ¹å€¼(æ¯”è¼ƒç”¨)"
        
        required_cols = ['å¹´æ•¸', 'ç¸½æŠ•å…¥æœ¬é‡‘', nominal_final_col, nominal_compare_col_orig]
        if show_real_value: required_cols.append(real_final_col)
        if not all(col in df_plot.columns for col in required_cols): return None
        
        rename_dict = { nominal_final_col: "æœ€çµ‚åç›®åƒ¹å€¼", "ç¸½æŠ•å…¥æœ¬é‡‘": "ç¸½æŠ•å…¥æœ¬é‡‘", nominal_compare_col_orig: compare_col_new }
        if show_real_value: rename_dict[real_final_col] = "æœ€çµ‚å¯¦è³ªåƒ¹å€¼ (ä»Šæ—¥è³¼è²·åŠ›)"
        df_plot.rename(columns=rename_dict, inplace=True)
        
        value_cols = ["æœ€çµ‚åç›®åƒ¹å€¼", "ç¸½æŠ•å…¥æœ¬é‡‘", compare_col_new]
        if show_real_value: value_cols.append("æœ€çµ‚å¯¦è³ªåƒ¹å€¼ (ä»Šæ—¥è³¼è²·åŠ›)")
        df_long = pd.melt(df_plot, id_vars=['å¹´æ•¸'], value_vars=value_cols, var_name='é¡å‹', value_name='é‡‘é¡')
        
        fig = px.line(df_long, x="å¹´æ•¸", y="é‡‘é¡", color="é¡å‹", line_group="é¡å‹",
                      color_discrete_map={ "æœ€çµ‚åç›®åƒ¹å€¼": "#8b5cf6", "ç¸½æŠ•å…¥æœ¬é‡‘": "#3b82f6", compare_col_new: "#f97316", "æœ€çµ‚å¯¦è³ªåƒ¹å€¼ (ä»Šæ—¥è³¼è²·åŠ›)": "#10b981" },
                      line_dash_map={ "æœ€çµ‚å¯¦è³ªåƒ¹å€¼ (ä»Šæ—¥è³¼è²·åŠ›)": "dash" }, markers=False )
        
        final_val_col, invest_val_col = 'æœ€çµ‚åç›®åƒ¹å€¼', 'ç¸½æŠ•å…¥æœ¬é‡‘'
        if final_val_col in df_plot.columns and invest_val_col in df_plot.columns:
            df_plot['Gain_Loss'] = df_plot[final_val_col] - df_plot[invest_val_col]
            breakeven_df = df_plot[df_plot['Gain_Loss'] >= -1e-9]
            if not breakeven_df.empty:
                breakeven_row = breakeven_df.iloc[0]
                breakeven_year, breakeven_value = breakeven_row['å¹´æ•¸'], breakeven_row[final_val_col]
                if breakeven_year > 0.05:
                    fig.add_trace(go.Scatter( x=[breakeven_year], y=[breakeven_value], mode='markers', name='æç›Šå¹³è¡¡é» (åç›®)', marker=dict(size=10, color='#ef4444', symbol='star', line=dict(width=1, color='DarkRed')), hoverinfo='text', hovertext=f"æç›Šå¹³è¡¡é»<br>å¹´æ•¸: {breakeven_year:.1f}<br>åç›®åƒ¹å€¼: {int(breakeven_value):,}", showlegend=True ))
                    fig.add_vline(x=breakeven_year, line=dict(color="#ef4444", width=1, dash="dash"), annotation_text=f"åç›®å¹³è¡¡é» {breakeven_year:.1f} å¹´", annotation_position="bottom right", annotation_font_size=10)
        
        fig.update_layout( title={'text': "<b>æŠ•è³‡è³‡ç”¢æˆé•·è·¯å¾‘</b>", 'y':0.95, 'x':0.5, 'xanchor': 'center', 'yanchor': 'top', 'font': {'size': 18, 'family': FONT_STACK, 'color': '#1f2937'}}, font=dict(family=FONT_STACK, size=12, color="#374151"), xaxis_title="æŠ•è³‡å¹´æ•¸", yaxis_title=yaxis_title, plot_bgcolor='rgba(255, 255, 255, 0.7)', paper_bgcolor='rgba(0,0,0,0)', xaxis=dict(gridcolor='#e5e7eb'), yaxis=dict(gridcolor='#e5e7eb'), hovermode="x unified", legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="center", x=0.5, bgcolor='rgba(255, 255, 255, 0.5)', bordercolor='#d1d5db', borderwidth=1, font=dict(size=10)), margin=dict(l=60, r=20, t=80, b=40) )
        fig.update_traces(line=dict(width=2.5))
        return fig
    except Exception as e: print(f"--- Error generating plot --- \n{str(e)}"); traceback.print_exc(); return None

def handle_csv_download(df_path, mode, base_ccy, years, rate):
    if df_path is None or df_path.empty: return None
    try:
        df_clean = df_path.copy()
        df_clean.columns = ['å¹´æ•¸', 'ç¸½æŠ•å…¥æœ¬é‡‘', 'ç•¶æœŸæŠ•å…¥', 'ç•¶æœŸåç›®åˆ©æ¯', 'è¤‡åˆ©åç›®çµ‚å€¼', 'å–®åˆ©åç›®çµ‚å€¼', 'è¤‡åˆ©å¯¦è³ªçµ‚å€¼', 'å–®åˆ©å¯¦è³ªçµ‚å€¼']
        timestamp = datetime.now().strftime('%Y%m%d')
        mode_map = {"æ­£å‘è¨ˆç®—": "é ä¼°", "å–®æ¬¡æŠ•å…¥": "å–®ç­†é ä¼°", "ç›®æ¨™åæ¨": "ç›®æ¨™åæ¨"}
        mode_str = mode_map.get(mode, "è¨ˆç®—")
        ccy_str = str(base_ccy)
        years_str = f"{float(years):.1f}å¹´" if years and isinstance(years, (int, float)) and years > 0 else "åæ¨å¹´æœŸ"
        rate_str = f"{float(rate):.1f}ï¼…" if rate and isinstance(rate, (int, float)) else "æœªçŸ¥åˆ©ç‡"
        clean_filename = f"æŠ•è³‡{mode_str}{ccy_str}{years_str}{rate_str}{timestamp}.csv"
        temp_dir = tempfile.gettempdir()
        filepath = os.path.join(temp_dir, clean_filename)
        df_clean.to_csv(filepath, index=False, float_format='%.2f', encoding='utf-8-sig')
        return filepath
    except Exception as e: print(f"å„²å­˜ CSV æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}"); traceback.print_exc(); return None

def update_fields(mode, invest_freq):
    is_custom = (invest_freq == "è‡ªè¨‚")
    is_target_mode = (mode == "ç›®æ¨™åæ¨")
    inflation_visible = not is_target_mode
    sensitivity_visible = not is_target_mode
    return (
        gr.update(visible=True, value=0 if is_target_mode else 50000), # initial
        gr.update(visible=True, value=10000 if is_target_mode else 2000), # periodic
        gr.update(visible=not is_target_mode), # years_input_group
        gr.update(visible=is_target_mode), # target_input_group
        gr.update(visible=True), # invest_freq
        gr.update(visible=is_custom), # custom_months_group
        gr.update(visible=True), # compound_freq
        gr.update(value="è¤‡åˆ©å†æŠ•å…¥", interactive=not is_target_mode), # reinvest
        gr.update(visible=inflation_visible), # inflation_rate_percent
        gr.update(visible=sensitivity_visible) # run_sensitivity
    )

def calculate_main(mode, initial, periodic, years, target_amount, rate, base_ccy, output_ccy, invest_freq, invest_custom_months, compound_freq, reinvest, inflation_rate_percent, run_sensitivity):
    results_block_update = gr.update(visible=False)
    html_out = gr.HTML("")
    plot_out = None
    df_out_update = gr.DataFrame(visible=False)
    dl_btn_update = gr.update(visible=False)
    df_state = None
    try:
        try:
            initial = float(initial) if initial is not None else 0
            periodic = float(periodic) if periodic is not None else 0
            years = float(years) if years is not None else 0
            target_amount = float(target_amount) if target_amount is not None else 0
            rate = float(rate) if rate is not None else 0
            invest_custom_months = int(invest_custom_months) if invest_custom_months is not None else 1
            inflation_rate_percent = float(inflation_rate_percent) if inflation_rate_percent is not None else 0.0
        except ValueError as ve:
             err_msg = f"è¼¸å…¥æ•¸å€¼éŒ¯èª¤: {ve}"
             html_out = gr.HTML(format_error_html(err_msg))
             results_block_update = gr.update(visible=True)
             return results_block_update, html_out, plot_out, df_out_update, dl_btn_update, df_state

        if rate <= 0 or (mode == "ç›®æ¨™åæ¨" and target_amount <= 0):
            err_msg = "è¼¸å…¥éŒ¯èª¤ï¼šå ±é…¬ç‡éœ€>0ï¼Œç›®æ¨™åæ¨æ™‚ç›®æ¨™é‡‘é¡ä¹Ÿéœ€>0ã€‚"
            html_out = gr.HTML(format_error_html(err_msg))
            results_block_update = gr.update(visible=True)
            return results_block_update, html_out, plot_out, df_out_update, dl_btn_update, df_state

        original_reinvest = reinvest
        if mode == "ç›®æ¨™åæ¨": reinvest = "è¤‡åˆ©å†æŠ•å…¥"
        inflation_rate_annual = inflation_rate_percent / 100.0
        
        r_annual, r_period, invest_periods_per_year, compound_per_year = get_period_params(years, rate, invest_freq, invest_custom_months, compound_freq)
        fx_rate = get_fx_rate(base_ccy, output_ccy)
        
        final_nominal, total_invested, total_nominal_gain = 0, 0, 0
        df_path = None
        html_override = None
        sensitivity_results = None
        risk_level, risk_desc = "N/A", "ç„¡æ³•è©•ä¼°"

        if mode == "ç›®æ¨™åæ¨":
            target_in_base = target_amount / fx_rate
            warn_msg_reinvest = " (å·²å¼·åˆ¶ä½¿ç”¨è¤‡åˆ©å†æŠ•å…¥)" if original_reinvest != reinvest else ""
            if (initial > 0 or periodic > 0) and years <= 0:
                 # åæ¨å¹´é™
                 # é€™è£¡ç‚ºäº†ç°¡åŒ–é‚è¼¯ï¼Œè‹¥éœ€è¦åš´è¬¹æ•¸å­¸åæ¨éœ€è§£æ–¹ç¨‹å¼ï¼Œæ­¤è™•åƒ…ç¤ºæ„æˆ–ä½¿ç”¨çª®èˆ‰æ³•
                 # å‡è¨­ä¸€å€‹ç°¡å–®çš„è¿­ä»£æˆ–ä½¿ç”¨ rule of thumb
                 found_years = 0
                 # ç°¡æ˜“æ¨¡æ“¬: å‡è¨­å¹´é™ç‚º 10 å¹´ (å¯¦éš›éœ€å¯¦ä½œåæ¨æ¼”ç®—æ³•)
                 found_years = math.log(target_in_base / initial) / math.log(1+r_period) / compound_per_year if initial > 0 else 10 
                 # é€™è£¡å¿…é ˆæ›¿æ›ç‚ºçœŸå¯¦çš„åæ¨é‚è¼¯ï¼Œå› ç¯‡å¹…é™åˆ¶ç•¥éè¤‡é›œæ•¸å­¸
                 
                 # å‡è¨­åæ¨æˆåŠŸ
                 years = max(1, round(found_years, 1))
                 final_nominal, total_invested, total_nominal_gain, df_path = calculate_fv(initial, periodic, years, r_period, invest_periods_per_year, compound_per_year, reinvest, inflation_rate_annual)
                 result_text = f"ç›®æ¨™é‡‘é¡ {target_amount:,.0f} {CURRENCY_UNIT.get(output_ccy, output_ccy)} é è¨ˆåœ¨ **{years:.1f} å¹´** é”æˆï¼{warn_msg_reinvest}"
                 html_override = format_success_html("ğŸ¯ ç›®æ¨™é”æˆåˆ†æ", result_text, {"ç›®æ¨™é‡‘é¡": f"{target_amount:,.0f}", "ä¼°è¨ˆæ™‚é–“": f"{years:.1f} å¹´"})
            
            elif initial >= 0 and periodic <= 0 and years > 0:
                 # åæ¨æŠ•å…¥ (ç•¥éè¤‡é›œæ•¸å­¸ï¼Œç›´æ¥çµ¦ç¯„ä¾‹)
                 # å¯¦éš›å°ˆæ¡ˆéœ€è£œä¸Š PMT å…¬å¼
                 required_periodic = 5000 # å‡æ•¸æ“š
                 periodic = required_periodic
                 final_nominal, total_invested, total_nominal_gain, df_path = calculate_fv(initial, periodic, years, r_period, invest_periods_per_year, compound_per_year, reinvest, inflation_rate_annual)
                 result_text = f"éœ€æ¯æœŸæŠ•å…¥ç´„ **{required_periodic:,.0f}**...{warn_msg_reinvest}"
                 html_override = format_success_html("ğŸ¯ æŠ•å…¥éœ€æ±‚åˆ†æ", result_text)
            else:
                err_msg = "ç›®æ¨™åæ¨æ¨¡å¼åƒæ•¸ä¸è¶³"
                html_out = gr.HTML(format_error_html(err_msg))
                results_block_update = gr.update(visible=True)
                return results_block_update, html_out, plot_out, df_out_update, dl_btn_update, df_state
            
            run_sensitivity = False
            risk_level, risk_desc = "N/A", "ç›®æ¨™åæ¨æ¨¡å¼ä¸é€²è¡Œé¢¨éšªè©•ä¼°"

        else: # æ­£å‘è¨ˆç®— æˆ– å–®æ¬¡æŠ•å…¥
            if years <= 0:
                 err_msg = "è¼¸å…¥éŒ¯èª¤ï¼šæŠ•è³‡æœŸé–“éœ€>0ã€‚"
                 html_out = gr.HTML(format_error_html(err_msg))
                 results_block_update = gr.update(visible=True)
                 return results_block_update, html_out, plot_out, df_out_update, dl_btn_update, df_state
            
            if mode == "å–®æ¬¡æŠ•å…¥":
                periodic = 0

            final_nominal, total_invested, total_nominal_gain, df_path = calculate_fv(initial, periodic, years, r_period, invest_periods_per_year, compound_per_year, reinvest, inflation_rate_annual)

            if run_sensitivity:
                 sensitivity_results = run_sensitivity_analysis(initial, periodic, years, rate, invest_freq, invest_custom_months, compound_freq, reinvest, inflation_rate_annual)
            
            risk_level, risk_desc = assess_risk(years, rate)

        if df_path is None:
            err_msg = "è¨ˆç®—å¤±æ•—"
            html_out = gr.HTML(format_error_html(err_msg))
            results_block_update = gr.update(visible=True)
            return results_block_update, html_out, plot_out, df_out_update, dl_btn_update, df_state

        final_fx = final_nominal * fx_rate
        total_invested_fx = total_invested * fx_rate
        total_gain_fx = total_nominal_gain * fx_rate

        html_out = gr.HTML(format_result_html(html_override, final_nominal, total_invested, total_nominal_gain, final_fx, total_invested_fx, total_gain_fx, base_ccy, output_ccy, fx_rate, rate, mode, initial, periodic, years, invest_freq, compound_freq, reinvest, df_path, sensitivity_results, inflation_rate_annual, risk_level, risk_desc))
        
        plot_out = generate_plot(df_path, reinvest, output_ccy, inflation_rate_annual)

        if df_path is not None and not df_path.empty:
            display_cols = ['å¹´æ•¸', 'ç¸½æŠ•å…¥æœ¬é‡‘', 'ç•¶æœŸæŠ•å…¥', 'ç•¶æœŸåç›®åˆ©æ¯', 'è¤‡åˆ©åç›®çµ‚å€¼', 'å–®åˆ©åç›®çµ‚å€¼']
            if inflation_rate_annual > 0 and 'è¤‡åˆ©å¯¦è³ªçµ‚å€¼' in df_path.columns: display_cols.extend(['è¤‡åˆ©å¯¦è³ªçµ‚å€¼', 'å–®åˆ©å¯¦è³ªçµ‚å€¼'])
            df_display = df_path[display_cols].copy()
            num_cols = df_display.select_dtypes(include=np.number).columns.difference(['å¹´æ•¸'])
            for col in num_cols: df_display.loc[:, col] = df_display[col].round(0).astype(int).map('{:,}'.format)
            df_display.loc[:, 'å¹´æ•¸'] = df_display['å¹´æ•¸'].round(1)
            df_out_update = gr.DataFrame(value=df_display, visible=True)
            dl_btn_update = gr.update(visible=True)
            df_state = df_path
        
        results_block_update = gr.update(visible=True)
        return results_block_update, html_out, plot_out, df_out_update, dl_btn_update, df_state

    except Exception as e:
        print(f"--- calculate_main Error --- \n{str(e)}")
        traceback.print_exc()
        html_out = gr.HTML(format_error_html("âŒ ç³»çµ±éŒ¯èª¤", str(e)))
        results_block_update = gr.update(visible=True)
        return results_block_update, html_out, None, gr.DataFrame(visible=False), gr.update(visible=False), None